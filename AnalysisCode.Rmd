---
title: "MU Analysis NEPHU Catchment"
author: "Prepared by: Des Gul"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: html_document
knit: (function(input, ...) {
  rmarkdown::render(input, output_file = paste0("MU Report_NEPHU_", format(Sys.Date(), "%d %b %Y")), output_dir = "../Output") })
---
<br>

Data period: Data from 1 January 2021 - 31 Dec 2024

```{r setup, include=FALSE}
con <- DBI::dbConnect(odbc::odbc(), "PHAR")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=13, connection="con")

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, ft.align="left")
```

```{r}
library(DBI)
library(rio)
library(here)
library(tidyverse)
library(janitor)
library(sf)
library(flextable)

```


```{r extract_data}
mu_raw <- dbGetQuery(con, 
"
SELECT * FROM dh_public_health.phess_release.caseevents 
WHERE CONDITION_TYPE = 'Sexually Transmissible Infections' 
AND EVENT_DATE BETWEEN '2022-01-01' AND '2024-12-31' 
ORDER BY EVENT_DATE DESC; 
"
)

mu_data_raw <- mu_raw

```


```{r load data}
data_file <- "MUdata_VIC_20240409.xlsx"
data_file <- "MUdata_VIC_20250108.xlsx"
#lab_data_file <- "MUdata_wlab_VIC_20240404.xlsx"

mu_data_raw <- import(here("Data", data_file)) %>% 
  clean_names() %>% 
  remove_empty("cols") %>% 
  #select(-c(event_id1, event_id4, event_id10, event_id11, party_id12, unid3)) %>% 
  mutate(across(where(is.POSIXct), ymd)) %>% 
  rename(defn = event_classification, 
         age = age_years, 
         atsi = indigenous_status, 
         cob = country_of_birth)

```

``` {r data inspect}
confirmed <- filter(mu_data_raw, defn=="Confirmed")
reject <- filter(mu_data_raw, defn %in% c("Rejected", "Not notifiable"))
probable <- filter(mu_data_raw, defn=="Probable")

```

``` {r configure}
# setup factor variables levels
nephu_lgas <- c("Banyule (C)", "Boroondara (C)", "Darebin (C)", "Hume (C)", "Knox (C)", "Manningham (C)", "Maroondah (C)", "Nillumbik (S)", "Whitehorse (C)", "Whittlesea (C)", "Yarra (C)", "Yarra Ranges (S)")

nephu_lgas_short <- c("Banyule", "Boroondara", "Darebin", "Hume", "Knox", "Manningham", "Maroondah", "Nillumbik", "Whitehorse", "Whittlesea", "Yarra", "Yarra Ranges")

agecat5_levels <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")

# reconfigure data to include age grps, factors and epi-dates variables
mu_data_config <- mu_data_raw %>% 
  mutate(agecat5 = case_when(between(age, 0, 4) ~ "0-4", 
                             between(age, 5, 9) ~ "5-9",
                             between(age, 10, 14) ~ "10-14",
                             between(age, 15, 19) ~ "15-19",
                             between(age, 20, 24) ~ "20-24",
                             between(age, 25, 29) ~ "25-29",
                             between(age, 30, 34) ~ "30-34",
                             between(age, 35, 39) ~ "35-39",
                             between(age, 40, 44) ~ "40-44",
                             between(age, 45, 49) ~ "45-49",
                             between(age, 50, 54) ~ "50-54",
                             between(age, 55, 59) ~ "55-59",
                             between(age, 60, 64) ~ "60-64",
                             between(age, 65, 69) ~ "65-69",
                             between(age, 70, 74) ~ "70-74",
                             between(age, 75, 79) ~ "75-79",
                             between(age, 80, 84) ~ "80-84",
                             between(age, 85, 99) ~ "85+", 
                             TRUE ~ NA_character_), 
         agecat5 = factor(agecat5, levels=agecat5_levels), 
         aus_born = case_when(cob=="Australia" ~ "Australia", 
                              cob=="Not Stated" ~ "Not Stated", 
                              cob=="Unknown" ~ "Not Stated", 
                              TRUE ~ "Overseas"), 
         aus_born = factor(aus_born, levels=c("Australia", "Overseas", "Not stated")), 
         defn = factor(defn, levels=c("Confirmed", "Probable", "Suspected", "Rejected", "Not notifiable")), 
         sex = factor(sex, levels=c("Female", "Male", "Not stated", "Other")), 
         atsi = fct_collapse(factor(atsi, levels=c("Aboriginal and Torres Strait Islander origin", "Aboriginal but not Torres Strait Islander origin", "Not Aboriginal or Torres Strait Islander", "Missing/Not Stated")), `Aboriginal and/or Torres Strait Islander` = c("Aboriginal and Torres Strait Islander origin", "Aboriginal but not Torres Strait Islander origin")), 
         epi_MY = my(paste(month(event_date), year(event_date), sep="-")), 
         epiyear = epiyear(event_date), 
         epi_Y = ymd(paste0(epiyear, "-01-01")), 
         epiweek = epiweek(event_date), 
         epimonth = month(event_date, label=TRUE), 
         epi_WY = ceiling_date(event_date, "week") -1, 
         mth_yr = paste(epimonth, epiyear)) %>% 
  remove_empty("cols")

mu_nephu_multiplelines <- mu_data_config %>% 
  filter(lga %in% nephu_lgas) %>% 
  remove_empty("cols")

mu_nephu_singleline <- mu_nephu_multiplelines %>% 
  distinct(event_id, .keep_all=TRUE)

notification_table <- tabyl(mu_nephu_singleline, defn) %>% 
  mutate(percent = round(100 * percent, 1)) %>% 
  flextable() %>% 
  set_header_labels(defn = "Case Classification", n="Cases", percent="% of total cases") %>% 
  autofit()

mu_nephu_prob <- filter(mu_nephu_singleline, defn=="Probable")

mu_raw_nephu_prob <- filter(mu_data_raw, event_id %in% mu_nephu_prob$event_id)

mu_nephu <- mu_nephu_multiplelines %>% 
  filter(primary_exposure=="Primary") %>% 
  filter(test_facility=="Victorian Infectious Diseases Reference Laboratory  - Melbourne Health" |
           test_facility=="Melbourne Pathology Pty Ltd" | 
           test_facility=="Australian Clinical Laboratories (formerly Healthscope Pathology)") %>% # 1 probable case with only histology done at lab
  distinct(event_id, .keep_all=TRUE)
# tabyl(mu_nephu, test_facility)
# tabyl(mu_data_config, event_type) # all cases

mu_vic <- mu_data_config %>% 
  filter(primary_exposure=="Primary") %>% 
  filter(test_facility=="Victorian Infectious Diseases Reference Laboratory  - Melbourne Health" |
           test_facility=="Melbourne Pathology Pty Ltd") %>%
  distinct(event_id, .keep_all=TRUE)

mu_lphu <- mu_vic %>% 
  filter(event_date >= "2022-07-01") %>% # date when codes no longer used for lphu
  select(event_id, event_date, epi_MY, lphu) %>% 
  mutate(lphu = factor(lphu, levels=c("NEPHU", "SEPHU", "WPHU", "BSWPHU", "GPHU", "GVPHU", "GWSMPHU", "LMPHU")))

# not_notifiable <- mu_data_config %>% 
#   filter(defn=="Not notifiable")

mu_nephu_vic_counts_mth <- mu_vic %>% 
  filter(defn %in% c("Confirmed", "Probable")) %>% 
  group_by(epi_MY) %>% 
  summarise(total = n()) %>% 
  left_join(mu_nephu %>% group_by(epi_MY) %>% summarise(total_nephu = n()), by="epi_MY") %>% 
  replace_na(replace=list(total_nephu=0)) %>% 
  mutate(pct_nephu = round(total_nephu/total*100, 1))


mu_nephu_vic_counts_yr <- tabyl(mu_vic %>% filter(defn %in% c("Confirmed", "Probable")), epiyear) %>% 
  left_join(tabyl(mu_nephu %>% filter(defn %in% c("Confirmed", "Probable")), epiyear), by="epiyear") %>% 
  #add_column(., tabyl(mu_nephu %>% filter(defn %in% c("Confirmed", "Probable")), epiyear)) %>% 
  adorn_totals("row") %>% 
  rename(VIC = n.x, 
         NEPHU = n.y) %>% 
  select(epiyear, VIC, NEPHU) %>% 
  mutate(pct_nephu = round(NEPHU/VIC*100, 1)) %>% 
  flextable() %>% 
  set_header_labels(epiyear = "Year", pct_nephu = "% of VIC") %>% 
  autofit() %>% 
  #add_footer_lines("2024 is part year from Jan to Mar") %>% 
  add_footer_lines("Cases include Confirmed and Probable cases")

```

### *M. ulcerans* case notifications in NEPHU catchment


There was a total of `r nrow(mu_nephu_singleline)` notifications for *M. ulcerans* in the NEPHU catchment during the above-mentioned time period.

These case notifications were categorised as follows:
`r notification_table`

<br>

For surveillance purpose, only confirmed and probable cases will be considered in this report from this point on.
<br>

**Total annual *M. ulcerans* cases and proportion of Victorian cases**

`r mu_nephu_vic_counts_yr`


<br>


``` {r}
# investigate the cases without VIDRL lab test to see if they are also present in nephu dataset or omitted
mu_nephu_nonVIDRL <- mu_nephu_multiplelines %>% 
  filter(primary_exposure=="Primary") %>% 
  filter(test_facility!="Victorian Infectious Diseases Reference Laboratory  - Melbourne Health") %>% 
  #filter(is.na(test_facility_notes)) %>% 
  distinct(event_id, .keep_all=TRUE)

mu_nephu_melbpath <- mu_nephu_multiplelines %>% 
  filter(primary_exposure=="Primary") %>% 
  filter(test_facility=="Melbourne Pathology Pty Ltd") %>% 
  distinct(event_id, .keep_all=TRUE)

# setdiff(mu_nephu_melbpath$event_id, mu_nephu$event_id)
# 
# 
# nonVIDRL_ids <- mu_nephu_nonVIDRL$event_id
# 
# mu_nephu_matchnonVIDRL <- filter(mu_nephu, event_id %in% nonVIDRL_ids)
# 
# setdiff(mu_nephu_nonVIDRL$event_id, mu_nephu_matchnonVIDRL$event_id)
# 
# tabyl(mu_nephu, sex)
```



``` {r epi curve}
# A function factory for getting integer y-axis values (https://gist.github.com/jhrcook/eb7b63cc57c683a6eb4986c4107a88ec)
integer_breaks <- function(n = 5, ...) {
    fxn <- function(x) {
        breaks <- floor(pretty(x, n, ...))
        names(breaks) <- attr(breaks, "labels")
        breaks
    }
    return(fxn)
}

# create the breaks for histogram
epimonth_breaks_nephu <- c(seq.Date(from=min(mu_nephu$epi_MY), to=max(mu_nephu$epi_MY), by="month"), 
                           max(mu_nephu$epi_MY) + months(1))

epimonth_breaks_lphu <- c(seq.Date(from=min(mu_lphu$epi_MY), to=max(mu_lphu$epi_MY), by="month"), 
                          max(mu_lphu$epi_MY) + months(1))

# create scale factor for sec axis
sec_sf <- max(mu_nephu_vic_counts_mth$total_nephu) / max(mu_nephu_vic_counts_mth$pct_nephu)

# plot of nephu cases over time with pct of VIC cases on sec axis
nephu_plot <- ggplot(data = mu_nephu_vic_counts_mth) +
  geom_col(aes(x = epi_MY, y=total_nephu, group = 1, fill = "MU cases"), col="gray") + 
  geom_line(aes(x= epi_MY, y=pct_nephu * sec_sf, group=1, col="percentage")) + 
  scale_fill_manual(values="#F8766D", name="") + 
  scale_colour_manual(values=c("#619CFF"), name="") + 
  scale_x_date(expand=c(0,0), date_breaks="1 month", date_minor_breaks="month", date_labels="%b %Y", name="") +
  scale_y_continuous(expand=c(0,0), name="Monthly notified cases", breaks=integer_breaks(), 
                     sec.axis = sec_axis(~./sec_sf, name="% of Vic cases")) + 
  cowplot::theme_cowplot() + 
  theme(plot.caption = element_text(size=11), 
        axis.text.x = element_text(angle = 45, hjust=1))

# epicurve of MU cases by LPHU
lphu_plot <- ggplot(data = mu_lphu) +
  geom_histogram(aes(x = epi_MY, group = fct_rev(lphu), fill = lphu), breaks=epimonth_breaks_lphu, closed="left", col="gray", boundary=-days(14)) +
  #scale_fill_manual(values=c("#F8766D", "#00BFC4", "#619CFF"), name="Condition") +
  scale_x_date(expand=c(0,0), date_breaks="1 month", date_labels="%b %Y", name="") +
  scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Monthly notified cases") + 
  scale_fill_discrete(name="LPHU", guide = guide_legend(reverse = TRUE)) + 
  #theme_minimal() + 
  cowplot::theme_cowplot() + 
  theme(plot.caption = element_text(size=11), 
        axis.text.x = element_text(angle = 45, hjust=1))
```

<br>

**Monthly cases in NEPHU catchment from Jan 2022 - Mar 2024 and percentage of VIC cases**

```{r}
nephu_plot
```

<br>

**Monthly cases by LPHU from Jul 2022 - Mar 2024**

```{r}
lphu_plot
```

Note that prior to July 2022 (before integration), data for allocated LPHU is not complete.
<br><br>


### Treatment outcomes

Table below shows the treatment outcomes at their 6-months followup.
<br>

```{r}
# load treatment data
treatment_file <- "MUdata_PHESS_wTmtOutcomes.xlsx"

mu_tmt_raw <- import(here("Data", treatment_file)) %>% 
  clean_names() 

mu_tmt_data <- mu_tmt_raw %>% 
  rename(outcome = what_was_the_outcome) %>% 
  select(phess_id, outcome) %>% 
  # due to multiple entries per case, some of which are conflicting, remove those that conflict
  mutate(outcome = str_remove(outcome, pattern="Still under treatment,"), 
         outcome = str_remove(outcome, pattern="Other,"), 
         outcome = str_remove(outcome, pattern="Lost to followup,"), 
         outcome = str_remove(outcome, pattern="Antibiotic treatment not completed,"))

tmt_outcomes <- left_join(mu_nephu, mu_tmt_data, by=c("event_id" = "phess_id")) %>% 
  select(event_id, outcome) %>% 
  separate_longer_delim(outcome, ",")

# assess cases that are still within 6month followup for tmt outcome data collection
outcomes_na <- filter(mu_tmt_data, is.na(outcome)) %>% 
  left_join(., mu_nephu, by=c("phess_id" = "event_id")) %>% 
  select(phess_id, outcome, event_date) %>% 
  mutate(post_6mth = if_else(event_date>="2023-09-30", "No", "Yes")) # ref date: 31/3/2024

#tabyl(outcomes_na, post_6mth)
outcome_data_notcollected_id <- outcomes_na %>% 
  filter(post_6mth=="Yes") %>% 
  pull(phess_id)

outcome_levels <- c("Antibiotic treatment completed", "Antibiotic treatment not completed", "Still under treatment", "Healed without surgery", "Healed with surgery", 
                    "Healed without limitation of joint movement", "Healed with limitation of joint movement", "Other", "Lost to followup", "Unable to obtain treatment outcome", "Data missing", "6 months followup not due")

outcomes_table <- tmt_outcomes %>% 
  mutate(outcome = if_else(event_id %in% outcome_data_notcollected_id, "Data missing", outcome), 
         outcome = if_else(is.na(outcome), "6 months followup not due", outcome), 
         outcome = factor(outcome, levels=outcome_levels)) %>% 
  tabyl(outcome) %>% 
  mutate(pct = round(n/104*100, 1))

flextable(outcomes_table, col_keys=c("outcome", "n", "pct")) %>% 
  set_header_labels(outcome="Treatment outcome", n="Count", pct="% of total cases\n(n=104)") %>% 
  autofit() %>% 
  add_footer_lines("Note that some cases have multiple outcomes listed")

```

<br><br>


### Demographic distribution of *M. ulcerans* cases in NEPHU

```{r pyramid}
# subset data
pyramid.dat <- mu_nephu %>% 
  select(age, agecat5, sex, defn) %>% 
  filter(sex %in% c("Male", "Female")) %>% 
  mutate(sex = fct_rev(fct_drop(sex)), 
         defn = fct_drop(defn))

# plot
# apyramid::age_pyramid(data=pyramid.dat, age_group="agecat5", split_by="sex", 
#                       stack_by="defn", show_midpoint=FALSE) + 
#   cowplot::theme_cowplot() + 
#   labs(y="cases", x="age group (years)", title="", fill="Case \nClassification") 

apyramid::age_pyramid(data=pyramid.dat, age_group="agecat5", split_by="sex", 
                      show_midpoint=FALSE) + 
  cowplot::theme_cowplot() + 
  labs(y="cases", x="age group (years)", title="", fill="Sex") 
```

<br>

### Risk factors and exposure locations (LGAs) for *M. ulcerans* cases in NEPHU

```{r risk factors}
# explore
# tabyl(mu_nephu, risk_factor)
# 
# tabyl(mu_nephu, risk_factor, endemic_areas_12months) %>% flextable() # not relevant since cannot isolate correct  endemic_areas_12months properly 
# 
# tabyl(mu_nephu, risk_factor, lga7) %>% flextable() # use this instead
# 
# tabyl(mu_nephu, risk_factor, events_caused_infection_type) %>% flextable() # multiple options - not useful

resid_risk <- mu_nephu %>% 
  filter(risk_factor=="Residence")

aus_travel_risk <- mu_nephu %>% 
  filter(risk_factor=="Travel within Australia")

# oddities <- mu_nephu %>% 
#   filter(endemic_areas_12months %in% c("Inner Melbourne", "No travel to known endemic areas", "Other", "Overseas", "NA_"))
# 
# data_ryecase <- mu_data_config %>% 
#   filter(event_id=="320235547593")
# 
# data_maroondahcase <- mu_data_config %>% 
#   filter(event_id=="320235538280")
# 
# data_unknownvic <- mu_nephu %>% 
#   filter(lga7=="Unknown Victoria")

# data_lgana <- mu_nephu_risk %>% 
#   filter(is.na(exp_lga))

exp_lga_levels = c("Bayside", "Kingston", "Moonee Valley", "Frankston", "Queenscliff", "Greater Geelong", "Surf Coast", "Mornington Peninsula", "East Gippsland", "Maroondah", "Banyule", "Hume", "Whitehorse", "Yarra Ranges")

risk_factor_levels = c("Holiday residence", "Travel within Australia", "Residence", "Risk unable to be determined")

mu_nephu_risk <- mu_nephu %>% 
  select(event_id, event_date, risk_factor, primary_exposure, risk_factors_exposure_site, lga3, postcode2, city, endemic_areas_12months, events_caused_infection_type) %>% 
  mutate(risk_factor = factor(risk_factor, levels=risk_factor_levels), 
         exp_lga = str_remove(lga3, pattern="[:space:]\\([:upper:]\\)"), 
         exp_lga = case_when(lga3=="Unknown Victoria" ~ "Mornington Peninsula", # recode as names states Mornington Peninsula
                             lga3=="Queenscliffe (B)" ~ "Queenscliff", # correction of lga spelling
                             TRUE ~ exp_lga), 
         exp_lga = factor(exp_lga, levels=exp_lga_levels)) 
```

**Risk factors for M. ulcerans cases in NEPHU**
<br>


``` {r}
risk_table <- tabyl(mu_nephu_risk, risk_factor) %>% 
  mutate(percent = round(100*percent, 0)) %>% 
  filter(!is.na(risk_factor)) %>% 
  select(-valid_percent)

flextable(risk_table) %>% 
  set_header_labels(risk_factor = "Risk factor", n = "Cases", percent = "%") %>% 
  autofit()

```
<br>
The majority of cases in NEPHU acquired *M. ulcerans* whilst visiting an endemic area.  
Such visits include having a holiday residence in an endemic area or travelling to an endemic area for holiday, recreational activity, visiting friends and family, among others.  Some cases may also have previously lived in an endemic area during their acquisition period, before to the NEPHU catchment.  

Only `r risk_table[4,2]` cases (`r risk_table[4,3]`%), had risk unable to be determined as they have not travelled to any endemic areas. Hence, exposure area is taken as their place of residence (i.e. NEPHU LGA)

<br>

Exposure areas for all NEPHU cases are shown in the table below.  Endemic areas for *M. ulcerans* are shown in red.

```{r}
tabyl(mu_nephu_risk %>% filter(!is.na(risk_factor)), risk_factor, exp_lga) %>% 
  flextable() %>% 
  set_header_labels(risk_factor = "", NA_ = "") %>% 
  add_header_row(values=c("Risk Factor", "Endemic LGAs", "", "", "", "", "", "", "", "", 
                          "Non-Endemic LGAs", "", "", "", "", 
                          "Unknown"), top=TRUE) %>% 
  merge_at(i=1, j=2:10, part="header") %>% 
  merge_at(i=1, j=11:15, part="header") %>% 
  merge_v(j=1, part="header") %>% 
  align(align="center", part="header") %>% 
  color(i=1, j=2, part="header", color="red") %>% 
  color(i=2, j=2:10, part="header", color="red") %>% 
  autofit() %>% 
  add_footer_lines("Travel within Australia denote travel to endemic areas for holiday, recreation, visiting friends, etc") %>% 
  add_footer_lines("Residence denote residence of case during acquisition period")
```

<br>

### Summary of cases with risk unable to be determined

```{r}
risk_utd_id <- filter(mu_nephu_risk, risk_factor=="Risk unable to be determined")$event_id

risk_utd_table <- mu_nephu %>% 
  filter(event_id %in% risk_utd_id)
risk_utd_table_short <- risk_utd_table %>% 
  select(event_id, event_date, date_of_onset, age, sex, postcode, lga)

flextable(risk_utd_table_short) %>% 
  set_header_labels(event_id = "PHESS ID", event_date = "Event date", date_of_onset = "Symptom onset date", age="Age", sex="Sex", postcode="Residential postcode", lga="LGA") %>% 
  autofit()
```


<br>

### Interactive map of M. ulcerans cases residential and exposure sites

```{r}
mu_exp_loc <- mu_nephu %>% 
  select(event_id, event_date, postcode, lga, latitude, longitude, risk_factor, primary_exposure, risk_factors_exposure_site, lga3, postcode2, city, risk_factors_exposure_site_latitude, risk_factors_exposure_site_longitude) 

mu_exp.sf <- mu_exp_loc %>% 
  filter(!is.na(risk_factors_exposure_site_latitude)) %>% 
  st_as_sf(., coords=c("risk_factors_exposure_site_longitude", "risk_factors_exposure_site_latitude"), crs=st_crs(4326))

mu_resid.sf <- mu_exp_loc %>% 
  st_as_sf(., coords=c("longitude", "latitude"), crs=4326) 

```

```{r}
# loadin VIC POA shapefiles
# abs_aus_poa.shp <- st_read(here("Data", "POA_2021_AUST_GDA2020_SHP/POA_2021_AUST_GDA2020.shp"))
# saveRDS(abs_aus_poa.shp, "aus_poa_shapefiles.rds")

wd <- getwd()
map_dir <- paste0(str_remove(wd, "/MU Analysis"), "/NEPHU Spatial Mapping")
load(file.path(map_dir, "NEPHU_basemaps_Robjects.RData"))
aus_poa_shp <- readRDS(here("Data", "aus_poa_shapefiles.rds"))

# create polygon for inner melbourne endemic area
mu_innermelb.sf <- aus_poa_shp %>% 
  filter(as.numeric(POA_CODE21) %in% c(3039, 3040, 3041, 3044, 3055)) %>% 
  st_transform(crs=4326)

nephu_lga_boundary_4326.sf <- st_transform(nephu_lga_boundary.sf, crs=4326)

```




Map below shows both the residential and primary risk exposure locations of NEPHU *M. ulcerans* cases notified during the data period specified above.  
This is an interactive map allowing you to zoom in and out and look at further details when hovering above the markers.  

Case residential sites denoted by blue dots.  
Case exposure sites denoted by lightblue markers with red cross.  
Inner Melbourne endemic area (Brunswick West, Pascoe Vale South, Essendon, Moonee Ponds and Strathmore) denoted by area marked in opaque-red.  
Area marked in thick black line represents the boundary of the NEPHU catchment.


```{r}
library(leaflet)

# format setup for mouse hover label
label_resid <- sprintf(
  "ID: %s<br/>Date: %s<br/>Risk: %s<br/>Exposure LGA: %s", 
  mu_resid.sf$event_id, mu_resid.sf$event_date, mu_resid.sf$risk_factor, mu_resid.sf$lga3
  ) %>% lapply(htmltools::HTML)
  
label_exp <- sprintf(
  "ID: %s<br/>Date: %s<br/>Risk: %s<br/>Exposure LGA: %s", 
  mu_exp.sf$event_id, mu_exp.sf$event_date, mu_exp.sf$risk_factor, mu_exp.sf$lga3
  ) %>% lapply(htmltools::HTML)

label_innermelb <- c("Inner Melbourne MU endemic area") %>% lapply(htmltools::HTML)

# combination leaflet
icons <- awesomeIcons(
  icon = 'close', 
  iconColor = 'red', 
  library = 'ion', 
  markerColor="lightblue"
)


leaflet() %>% 
  addTiles() %>% 
  addCircles(data=mu_resid.sf, radius=5, opacity=0.8, fillOpacity=0.6, group="Residential", label=label_resid) %>% 
  addAwesomeMarkers(data=mu_exp.sf, icon=icons, group="Exposure", label=label_exp) %>% 
  addPolygons(data=mu_innermelb.sf, color="red", label=label_innermelb) %>% 
  addPolygons(data=nephu_lga_boundary_4326.sf, color="black", fill=FALSE) %>% 
  addLayersControl(overlayGroups=c("Residential", "Exposure"), 
                   options=layersControlOptions(collapsed=FALSE)) %>% 
  setView(lng = 145.45, lat = -37.77, zoom=9)
  
  # # setView(lat=-38, lng=145, zoom=10) %>% 
  # addPolygons(color="#444444", weight=1, opacity=1.0, fillOpacity=0.8, smoothFactor=0.5, 
  #             fillColor= ~colorNumeric(rev(colorRamps::blue2red(6)), domain=pct)(pct), 
  #             highlightOptions = highlightOptions(color="white", weight=2, bringToFront = TRUE), 
  #             label = labels) %>% # alt: ~variable or ~function(vars)
  # addLegend(pal = colorNumeric(rev(colorRamps::blue2red(6)), nephu_bcs2periods_poa.sf$pct), 
  #           values = ~nephu_bcs2periods_poa.sf$pct, title="%", opacity=1, position="bottomright")


```

<br>
As mentioned earlier, only 5 cases had undetermined risk and their exposure site has been referred back to their residential location.  All other exposure sites are in *M. ulcerans* endemic areas which are outside of NEPHU catchment area.

There is one case who visited the nearby inner Melbourne endemic area of Brunswick West many times.  
So far, there has not been any reported cases in NEPHU who live near this inner Melbourne endemic area (highlighted in red in map above) whose exposure risk may have been their residential location.  This suggests that the risk of *M. ulcerans* exposure from this inner Melbourne endemic area has not yet expanded into the NEPHU catchment.


